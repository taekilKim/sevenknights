<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>세븐나이츠 리버스 도감</title>
    <link rel="stylesheet" href="/style.css" />
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DMD8LXSEQ5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DMD8LXSEQ5');
</script>
  </head>
  <body>
    <div class="layout">
      <header class="header">
        <div class="header-logo">
          <img src="/images/logo.png" alt="세븐나이츠 리버스 도감 로고" />
        </div>
      </header>

      <aside class="sidebar-left">
        <nav>
          <ul>
            <li>영웅 도감</li>
            <li>장비 도감</li>
            <li>레이드 공략</li>
          </ul>
        </nav>
      </aside>

      <main class="content">
        <div id="heroes"></div>
      </main>

      <aside class="sidebar-right">
        <div>
          <h3>정렬 / 필터</h3>
          <div class="filter-section">
            <label for="filter-type">유형</label>
            <select id="filter-type">
              <option value="">전체</option>
              <option value="공격형">공격형</option>
              <option value="방어형">방어형</option>
              <option value="마법형">마법형</option>
              <option value="지원형">지원형</option>
              <option value="만능형">만능형</option>
            </select>
          </div>
          <div class="filter-section">
            <label for="filter-rarity">희귀도</label>
            <select id="filter-rarity">
              <option value="">전체</option>
              <option value="전설+">전설+</option>
              <option value="전설">전설</option>
              <option value="희귀">희귀</option>
              <option value="고급">고급</option>
            </select>
          </div>
        </div>
      </aside>
    </div>

    <!-- Global Loading Overlay -->
    <div id="global-loading" class="loading-container" aria-hidden="true" style="display:flex;">
      <div class="spinner"></div>
      <div class="loading-text">L O A D I N G</div>
    </div>

    <script>
      function showLoading(on) {
        const el = document.getElementById("global-loading");
        if (!el) return;
        el.style.display = on ? "flex" : "none";
      }

      // Airtable 데이터 불러오기
      async function fetchHeroes() {
        showLoading(true);
        try {
          const response = await fetch("/api/heroes");
          const data = await response.json();
          const heroesContainer = document.getElementById("heroes");
          heroesContainer.innerHTML = "";

          // 방어 코드: records 확인
          if (!data.records || !Array.isArray(data.records)) {
            heroesContainer.textContent = "데이터를 불러오지 못했습니다. (records 없음)";
            console.error("서버 응답:", data);
            return;
          }

          data.records.forEach((record) => {
            const hero = record.fields ? { id: record.id, ...record.fields } : record;
            const card = document.createElement("div");
            card.className = "hero-card";

            // Airtable attachment 안전 추출 (thumbnails.large 우선, 없으면 url, 문자열이면 그대로)
            const attachment = Array.isArray(hero.portrait) ? hero.portrait[0] : null;
            const portraitUrl =
              typeof hero.portrait === "string"
                ? hero.portrait
                : (attachment?.thumbnails?.large?.url || attachment?.url || "");

            // rarity 한글 → 클래스명 매핑 (배경색은 CSS에서 처리)
            const rarityMap = {
              "전설+": "legendary-plus",
              "전설": "legendary",
              "희귀": "rare",
              "고급": "uncommon",
              "일반": "uncommon",
            };
            const rarityClass = rarityMap[hero.rarity] || "uncommon";
            // ⬇️ 배경 그라데이션은 카드에 적용 (기존 CSS와 동일한 훅)
            card.classList.add(`rarity-${rarityClass}`);

            if (portraitUrl) {
              // 이미지는 순수 wrapper에만
              const wrapper = document.createElement("div");
              wrapper.className = "hero-portrait"; // ← rarity 클래스 제거
              wrapper.style.position = "relative"; // 뱃지 포지셔닝용

              const img = document.createElement("img");
              img.src = portraitUrl;
              img.alt = hero.Name || hero.name || "이미지 없음";
              img.className = "hero-portrait-img";
              wrapper.appendChild(img);

              // 유형 뱃지
              if (hero.typeImage) {
                const typeBadge = document.createElement("img");
                typeBadge.src = hero.typeImage;
                typeBadge.alt = hero.type || "타입 배지";
                typeBadge.className = "hero-type-badge";
                wrapper.appendChild(typeBadge);
              }

              card.appendChild(wrapper);
            }

            const name = document.createElement("div");
            name.className = "hero-name";
            name.textContent = hero.Name || hero.name || "이름 없음";
            card.appendChild(name);

            if (hero.nickname) {
              const nickname = document.createElement("div");
              nickname.className = "hero-nickname";
              nickname.textContent = `${hero.nickname}`;
              card.appendChild(nickname);
            }

            if (hero.group) {
              const group = document.createElement("div");
              group.className = "hero-group";
              group.textContent = hero.group;
              card.appendChild(group);
            }

            const heroId = hero.id;
            card.addEventListener("click", () => {
              if (heroId) {
                sessionStorage.setItem("scrollPosition", window.scrollY);
                window.location.href = `/hero.html?id=${heroId}`;
              } else {
                console.error("영웅 ID가 정의되지 않았습니다:", hero);
              }
            });

            heroesContainer.appendChild(card);
          });
        } catch (error) {
          console.error("에러:", error);
          document.getElementById("heroes").textContent = "데이터 불러오기 오류";
        } finally {
          showLoading(false);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await fetchHeroes();
        const savedScroll = sessionStorage.getItem('scrollPosition');
        if (savedScroll) {
          window.scrollTo(0, parseInt(savedScroll));
          sessionStorage.removeItem('scrollPosition');
        }
      });
    </script>
  </body>
</html>