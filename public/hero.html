<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamic-title">영웅 상세 - 세븐나이츠 리버스 도감</title>
  <!-- SEO Meta Tags for Hero Detail Page -->
  <meta id="meta-description" name="description" content="세븐나이츠 리버스 영웅 상세 페이지" />
  <meta id="meta-keywords" name="keywords" content="세븐나이츠 리버스, 영웅, 상세, 도감, Seven Knights, Hero, Detail" />
  <meta name="author" content="세븐나이츠 리버스 도감" />
  <!-- Open Graph Meta Tags -->
  <meta property="og:site_name" content="세븐나이츠 리버스 도감" />
  <meta id="og-title" property="og:title" content="영웅 상세 - 세븐나이츠 리버스 도감" />
  <meta id="og-description" property="og:description" content="세븐나이츠 리버스 영웅의 상세 정보를 확인하세요." />
  <meta id="og-image" property="og:image" content="/default-hero-og-image.png" />
  <meta id="og-url" property="og:url" content="https://sk-dogam.app/hero.html" />
  <meta property="og:type" content="article" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta id="twitter-title" name="twitter:title" content="영웅 상세 - 세븐나이츠 리버스 도감" />
  <meta id="twitter-description" name="twitter:description" content="세븐나이츠 리버스 영웅의 상세 정보를 확인하세요." />
  <meta id="twitter-image" name="twitter:image" content="/default-hero-og-image.png" />
  <!-- Canonical Link -->
  <link id="canonical-link" rel="canonical" href="https://sk-dogam.app/hero.html" />
  <link rel="stylesheet" href="./style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2"></script>
</head>
<body class="hero-detail-page">
  <header class="hero-header">
    <button class="back-button" onclick="window.history.back()"><i class="ph-bold ph-caret-left"></i> 목록으로</button>
  </header>

  <main class="hero-detail-container">
    <section class="hero-top">
      <div class="hero-portrait-wrap">
        <img id="hero-portrait" class="hero-detail-portrait" alt="영웅 초상화" />
      </div>
      <div class="hero-basic-info">
        <h1 id="hero-name" class="hero-name"></h1>
        <p id="hero-nickname" class="hero-nickname"></p>
        <p id="hero-group" class="hero-group"></p>
        <div class="hero-meta">
          <span id="hero-type" class="hero-type"></span>
          <span id="hero-rarity" class="hero-rarity"></span>
        </div>
      </div>
    </section>

    <section class="hero-stats">
      <h2>스탯</h2>
      <table class="stats-table">
        <tr><td>공격력</td><td id="atk"></td></tr>
        <tr><td>방어력</td><td id="def"></td></tr>
        <tr><td>생명력</td><td id="hp"></td></tr>
        <tr><td>속공</td><td id="spd"></td></tr>
        <tr><td>치명타 확률(%)</td><td id="crit_rate"></td></tr>
        <tr><td>치명타 피해(%)</td><td id="crit_dmg"></td></tr>
        <tr><td>약점 공격 확률(%)</td><td id="weak_rate"></td></tr>
        <tr><td>막기 확률(%)</td><td id="block_rate"></td></tr>
        <tr><td>받는 피해 감소(%)</td><td id="dmg_reduce"></td></tr>
        <tr><td>효과 적중(%)</td><td id="eff_hit"></td></tr>
        <tr><td>효과 저항(%)</td><td id="eff_res"></td></tr>
      </table>
    </section>

    <section class="hero-skills">
      <h2>스킬</h2>
      <div class="skill attack-skill">
        <h3>기본 공격</h3>
        <img id="attack-image" alt="공격 이미지" />
        <p><strong id="attack-name" class="skill-name"></strong> <span id="attack-cooltime" class="skill-cooltime"></span></p>
        <p id="attack-desc" class="skill-desc"></p>
      </div>
      <div class="skill active-skill-1">
        <h3>액티브 스킬 1</h3>
        <img id="active-1-image" alt="액티브 스킬 1 이미지" />
        <p><strong id="active-1-name" class="skill-name"></strong> <span id="active-1-cooltime" class="skill-cooltime"></span></p>
        <p id="active-1-desc" class="skill-desc"></p>
      </div>
      <div class="skill active-skill-2">
        <h3>액티브 스킬 2</h3>
        <img id="active-2-image" alt="액티브 스킬 2 이미지" />
        <p><strong id="active-2-name" class="skill-name"></strong> <span id="active-2-cooltime" class="skill-cooltime"></span></p>
        <p id="active-2-desc" class="skill-desc"></p>
      </div>
      <div class="skill passive-skill">
        <h3>패시브</h3>
        <img id="passive-image" alt="패시브 이미지" />
        <p><strong id="passive-name" class="skill-name"></strong> <span id="passive-cooltime" class="skill-cooltime"></span></p>
        <p id="passive-desc" class="skill-desc"></p>
      </div>
    </section>

    <section class="hero-description">
      <h2>설명</h2>
      <p id="hero-description"></p>
    </section>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const heroId = params.get("id");

    if (!heroId) {
      document.querySelector("main").innerHTML = "<p>유효하지 않은 영웅 ID입니다.</p>";
    } else {
      fetch(`/api/hero/${heroId}`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(hero => {
          if (!hero || !hero.name) {
            document.querySelector("main").innerHTML = "<p>영웅 정보를 불러올 수 없습니다.</p>";
            return;
          }

          // Update SEO meta tags dynamically
          const heroTitle = `${hero.name} - 세븐나이츠 리버스 도감`;
          document.title = heroTitle;
          const titleEl = document.getElementById("dynamic-title");
          if (titleEl) titleEl.textContent = heroTitle;
          const desc = `${hero.name}의 상세 정보를 확인하세요.`;
          const ogDesc = hero.description || desc;
          const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(heroId)}`;
          // Description
          const descMeta = document.getElementById("meta-description");
          if (descMeta) descMeta.setAttribute("content", desc);
          // Keywords (add hero name, group, type)
          const keywordsMeta = document.getElementById("meta-keywords");
          if (keywordsMeta) {
            const keywords = [
              "세븐나이츠 리버스", "영웅", "상세", "도감", "Seven Knights", "Hero", "Detail",
              hero.name, hero.group, hero.type, hero.rarity
            ].filter(Boolean).join(", ");
            keywordsMeta.setAttribute("content", keywords);
          }
          // Open Graph
          const ogTitle = document.getElementById("og-title");
          if (ogTitle) ogTitle.setAttribute("content", heroTitle);
          const ogDescEl = document.getElementById("og-description");
          if (ogDescEl) ogDescEl.setAttribute("content", ogDesc);
          const ogImage = document.getElementById("og-image");
          if (ogImage) ogImage.setAttribute("content", hero.portrait || "/default-hero-og-image.png");
          const ogUrl = document.getElementById("og-url");
          if (ogUrl) ogUrl.setAttribute("content", url);
          // Twitter Card
          const twTitle = document.getElementById("twitter-title");
          if (twTitle) twTitle.setAttribute("content", heroTitle);
          const twDesc = document.getElementById("twitter-description");
          if (twDesc) twDesc.setAttribute("content", ogDesc);
          const twImage = document.getElementById("twitter-image");
          if (twImage) twImage.setAttribute("content", hero.portrait || "/default-hero-og-image.png");
          // Canonical
          const canonical = document.getElementById("canonical-link");
          if (canonical) canonical.setAttribute("href", url);

          // 기본 정보
          document.getElementById("hero-portrait").src = hero.portrait || "";
          // 다이아몬드 반짝 효과 (체크박스 필드 기반)
          if (hero.hasEffect) {
            const portraitWrap = document.querySelector(".hero-portrait-wrap");
            if (portraitWrap) {
              const diamond = document.createElement("div");
              diamond.className = "rarity-diamond-effect";
              portraitWrap.appendChild(diamond);
            }
          }
          // 희귀도별 배경색 클래스 적용
          const portraitEl = document.getElementById("hero-portrait");
          if (portraitEl) {
            const rarityClass = (() => {
              switch (hero.rarity) {
                case "전설+": return "legendary-plus";
                case "전설": return "legendary";
                case "희귀": return "rare";
                case "고급": return "uncommon";
                default: return "normal";
              }
            })();
            portraitEl.classList.add(`rarity-${rarityClass}`);
          }
          // hasEffect가 true면 초상화에 빛나는 테두리 클래스 부여
          if (hero.hasEffect === true || hero.hasEffect === "true" || hero.hasEffect === 1) {
            const portraitEl = document.getElementById("hero-portrait");
            if (portraitEl) {
              portraitEl.classList.add("has-effect");
            }
          }
          document.getElementById("hero-name").textContent = hero.name || "";
          document.getElementById("hero-nickname").textContent = hero.nickname || "";
          document.getElementById("hero-group").textContent = hero.group || "";
          document.getElementById("hero-type").textContent = hero.type || "";
          document.getElementById("hero-rarity").textContent = hero.rarity || "";

          // 스탯
          const statFields = ["atk","def","hp","spd","crit_rate","crit_dmg","weak_rate","block_rate","dmg_reduce","eff_hit","eff_res"];
          statFields.forEach(field => {
            document.getElementById(field).textContent = hero[field] || "-";
          });

          // 스킬 출력 함수
          const renderSkill = (prefix, skill) => {
            document.getElementById(`${prefix}-image`).src = skill?.image || "";
            document.getElementById(`${prefix}-name`).textContent = skill?.name || "";
            document.getElementById(`${prefix}-cooltime`).textContent = skill?.cooltime ? `쿨타임: ${skill.cooltime}` : "";
            document.getElementById(`${prefix}-desc`).textContent = skill?.desc || "";
          };

          renderSkill("attack", hero.attack);
          renderSkill("active-1", hero.active_1);
          renderSkill("active-2", hero.active_2);
          renderSkill("passive", hero.passive);

          document.getElementById("hero-description").textContent = hero.description || "";
        })
        .catch(err => {
          console.error("Hero fetch error:", err);
          document.querySelector("main").innerHTML = "<p>데이터를 불러오는 중 오류가 발생했습니다.</p>";
        });
    }
</script>

  <section class="hero-comments">
    <h2>의견 남기기</h2>
    <form id="comment-form">
      <input type="text" id="nickname" name="nickname" placeholder="닉네임" required />
      <textarea id="comment-content" name="content" placeholder="의견을 입력하세요..." required></textarea>
      <button type="submit">등록</button>
    </form>
    <ul id="comment-list" class="comment-list"></ul>
  </section>

  <script>
    const commentForm = document.getElementById("comment-form");
    const commentList = document.getElementById("comment-list");

    // 댓글 불러오기
    async function loadComments() {
      try {
        const res = await fetch(`/api/comments/${heroId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        commentList.innerHTML = "";
        (data.comments || []).forEach(comment => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${comment.nickname}</strong><p>${comment.content}</p><span>${comment.timestamp || ""}</span>`;
          commentList.appendChild(li);
        });
      } catch (err) {
        console.error("댓글 불러오기 오류:", err);
      }
    }

    // 댓글 등록
    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nickname = document.getElementById("nickname").value.trim();
      const content = document.getElementById("comment-content").value.trim();
      if (!nickname || !content) return alert("닉네임과 내용을 입력해주세요.");

      try {
        const res = await fetch(`/api/comments/${heroId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname, content }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        document.getElementById("comment-content").value = "";
        await loadComments();
      } catch (err) {
        console.error("댓글 등록 오류:", err);
        alert("댓글 등록 중 오류가 발생했습니다.");
      }
    });

    // 초기 로드
    loadComments();
  </script>
</body>
</html>